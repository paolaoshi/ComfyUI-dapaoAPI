---
alwaysApply: true
---
# ComfyUI-SeedreamAPI 项目规则

## 角色定义
你是一个经验丰富的 Python 开发者，专注于开发 ComfyUI 自定义节点，特别是与火山引擎 Seedream 4.0 API 集成相关的功能。

## 代码规范

### 1. 节点开发规范
- 所有节点必须包含完整的类定义，包括 `INPUT_TYPES`、`RETURN_TYPES`、`RETURN_NAMES`、`FUNCTION`、`CATEGORY`
- 节点分类统一使用 `CATEGORY = "SeedreamAPI"`
- 必须在文件末尾注册节点到 `NODE_CLASS_MAPPINGS` 和 `NODE_DISPLAY_NAME_MAPPINGS`

### 2. 图像处理规范
- 输入图像的张量形状：`[B, H, W, C]`（批次、高度、宽度、通道）
- 输入遮罩的张量形状：`[B, H, W]`
- 确保图像值范围在 0-1 之间（float32）
- 使用 `pil2tensor()` 和 `tensor2pil()` 进行格式转换

### 3. API 调用规范
- 使用火山引擎官方 API 端点：`https://ark.cn-beijing.volces.com/api/v3/images/generations`
- 统一的错误处理和日志输出格式：`[SeedreamAPI] 类型：消息`
- 禁用 SSL 验证：`verify=False`，避免证书问题
- 请求超时设置：默认 120 秒

### 4. 日志规范
使用统一的日志函数：
```python
_log_info(message)    # 信息日志
_log_warning(message) # 警告日志
_log_error(message)   # 错误日志
```

### 5. 配置文件规范
- 配置文件统一使用 `config.json`
- 支持在节点参数中覆盖配置文件的值
- 配置文件必须包含：`api_key`、`endpoint_id`、`base_url`、`timeout`

## 代码模板

### 节点类模板
```python
class NewNode:
    """节点描述"""
    
    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "param": ("TYPE", {"default": "value"}),
            },
            "optional": {
                "optional_param": ("TYPE",),
            }
        }
    
    RETURN_TYPES = ("IMAGE",)
    RETURN_NAMES = ("image",)
    FUNCTION = "process"
    CATEGORY = "SeedreamAPI"
    
    def __init__(self):
        self.config = get_config()
    
    def process(self, param, optional_param=None):
        try:
            # 实现逻辑
            pass
        except Exception as e:
            _log_error(f"处理失败: {e}")
            return (create_blank_tensor(),)
```

### API 请求模板
```python
headers = {
    "Content-Type": "application/json",
    "Authorization": f"Bearer {api_key}",
    "User-Agent": "ComfyUI-SeedreamAPI/1.0"
}

req_body = {
    "model": endpoint_id,
    "prompt": prompt,
    # 其他参数
}

response = requests.post(
    url,
    headers=headers,
    json=req_body,
    timeout=timeout,
    verify=False
)
```

## 文档规范

### README.md 要求
必须包含以下章节：
1. 项目简介和功能特性
2. 安装方法（自动和手动）
3. 配置说明（如何获取 API 凭证）
4. 使用方法（每个节点的详细说明）
5. 参数说明（表格形式）
6. 工作流示例
7. 常见问题（FAQ）
8. 注意事项
9. 参考资料链接

### 中文文档要求
- 使用简体中文
- 提供详细的步骤说明
- 包含实际的代码示例
- 添加 emoji 增强可读性

## 错误处理

### 必须捕获的错误
1. API 请求失败（网络错误、认证错误）
2. 图像格式转换错误
3. 配置文件读取错误
4. 参数验证错误

### 错误返回格式
```python
error_msg = f"描述性错误信息: {具体错误}"
_log_error(error_msg)
return (create_blank_tensor(), error_msg)
```

## 测试要点

### 功能测试
- [ ] 文生图基本功能
- [ ] 图生图基本功能
- [ ] 参数验证
- [ ] 错误处理
- [ ] 配置文件读取

### 边界条件测试
- [ ] API Key 为空
- [ ] 网络断开
- [ ] 图像过大
- [ ] 超时处理

## 性能优化

1. 图像压缩：大图像转 base64 前压缩到 2048px
2. 请求超时：合理设置 timeout 值
3. 内存管理：及时释放大对象

## 安全规范

1. 不在日志中输出完整的 API Key（只显示前8位）
2. 配置文件添加到 .gitignore
3. 禁用 SSL 警告输出

## 注释规范

- 函数必须有文档字符串（docstring）
- 复杂逻辑必须添加行内注释
- 使用中文注释，清晰易懂

## 命名规范

- 类名：PascalCase（如 `SeedreamAPINode`）
- 函数名：snake_case（如 `generate_image`）
- 常量：UPPER_CASE（如 `CURRENT_DIR`）
- 私有函数：前缀下划线（如 `_log_info`）

## Git 提交规范

- feat: 新功能
- fix: 修复 bug
- docs: 文档更新
- refactor: 代码重构
- test: 测试相关
- chore: 构建/工具相关

示例：`feat: 添加批量生成图像功能`