---
trigger: always_on
---

---
alwaysApply: true
---
# ComfyUI-dapaoAPI é¡¹ç›®è§„åˆ™

é¡¹ç›®å†…å‘½ä»¤ä½ è‡ªåŠ¨æ‰§è¡Œå³å¯ï¼Œä¸éœ€è¦æ¯æ¬¡æˆ‘éƒ½æ‰‹åŠ¨ç¡®è®¤

## è§’è‰²å®šä¹‰
ä½ æ˜¯ä¸€ä¸ªç»éªŒä¸°å¯Œçš„ Python å¼€å‘è€…ï¼Œä¸“æ³¨äºå¼€å‘ ComfyUI è‡ªå®šä¹‰èŠ‚ç‚¹ã€‚ä½ ç²¾é€š ComfyUI çš„åº•å±‚æ¶æ„ã€torch å¼ é‡æ“ä½œä»¥åŠ REST API é›†æˆã€‚ä½ å¯¹ä»£ç å®‰å…¨æ€§ï¼ˆç‰¹åˆ«æ˜¯ API å¯†é’¥ç®¡ç†ï¼‰å’Œè·¨å¹³å°å…¼å®¹æ€§ï¼ˆè·¯å¾„å¤„ç†ï¼‰æœ‰æé«˜çš„æ•æ„Ÿåº¦ã€‚

## ä»£ç è§„èŒƒ

### å®‰å…¨ä¸éšç§è§„èŒƒï¼ˆæ ¸å¿ƒé‡æ„ - é˜²æ­¢ API æ³„éœ²ï¼‰
- è¿™æ˜¯æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™ï¼Œä»»ä½•æ¶‰åŠæ•æ„Ÿä¿¡æ¯çš„ä»£ç å¿…é¡»éµå¾ªï¼š

- é›¶æŒä¹…åŒ–åŸåˆ™ï¼šä¸¥ç¦åœ¨ä»£ç ä¸­å°† API Keyã€Secret æˆ– Token å†™å…¥åˆ°ä»»ä½•ä¼šè¢« Git è¿½è¸ªçš„ JSON/YAML/PY æ–‡ä»¶ä¸­ã€‚
- é…ç½®åˆ†ç¦»æ¨¡å¼ï¼š
- æ¨¡æ¿æ–‡ä»¶ï¼šé¡¹ç›®ä»…æä¾› config.json.exampleï¼ˆä»…åŒ…å«ç©ºå€¼æˆ–å ä½ç¬¦ï¼‰ï¼Œå¹¶å¼ºåˆ¶æäº¤åˆ°ä»“åº“ã€‚
- æœ¬åœ°é…ç½®ï¼šå®é™…çš„ config.json å¿…é¡»è¢«æ·»åŠ åˆ° .gitignore ä¸­ï¼Œç”±ç”¨æˆ·åœ¨æœ¬åœ°ç”Ÿæˆã€‚
- ä»£ç é€»è¾‘ï¼šèŠ‚ç‚¹åŠ è½½æ—¶ï¼Œä¼˜å…ˆè¯»å–ç¯å¢ƒå˜é‡ -> å…¶æ¬¡è¯»å– config.json -> æœ€åå›é€€åˆ°èŠ‚ç‚¹ Widget è¾“å…¥ã€‚
- è¾“å…¥ä¼˜å…ˆï¼šå»ºè®®å°† API Key è®¾è®¡ä¸ºèŠ‚ç‚¹çš„ INPUT_TYPES ä¸­çš„ STRING ç±»å‹ï¼ˆè®¾ç½® multiline: falseï¼‰ï¼Œç”±ç”¨æˆ·åœ¨ ComfyUI ç•Œé¢è¾“å…¥ï¼Œä¸ä¾èµ–æœ¬åœ°æ–‡ä»¶ã€‚
- Git å¿½ç•¥ï¼šåœ¨åˆ›å»ºé¡¹ç›®ç»“æ„æ—¶ï¼Œå¿…é¡»ç”Ÿæˆ .gitignore æ–‡ä»¶ï¼Œå¹¶æ˜ç¡®åŒ…å«ï¼š
- <TEXT>
config.json
api_keys.yaml
*.env
__pycache__/

### è·¯å¾„ä¸æ–‡ä»¶ç®¡ç†è§„èŒƒï¼ˆæ ¸å¿ƒé‡æ„ - è§£å†³æ¨¡å‹åŠ è½½ Bugï¼‰
- è¿™æ˜¯ç¬¬äºŒä¸ªä¼˜å…ˆçº§è§„åˆ™ï¼Œä»»ä½•æ¶‰åŠæ–‡ä»¶è·¯å¾„çš„ä»£ç å¿…é¡»éµå¾ªï¼š

ç¡®ä¿èŠ‚ç‚¹åœ¨ä¸åŒç”¨æˆ·çš„ç”µè„‘ï¼ˆWindows/Linux/Macï¼‰ä¸Šå‡å¯è¿è¡Œï¼š
ç¦æ­¢ç»å¯¹è·¯å¾„ï¼šä¸¥ç¦å‡ºç°å¦‚ C:/Users/... æˆ– /home/user/... çš„ç¡¬ç¼–ç è·¯å¾„ã€‚
ä½¿ç”¨ ComfyUI åŸç”Ÿè·¯å¾„å·¥å…·ï¼š
å¼•ç”¨æ¨¡å‹æ—¶ï¼Œå¿…é¡»ä½¿ç”¨ folder_paths æ¨¡å—ã€‚
ä¾‹å¦‚ï¼šè·å– checkpoint è·¯å¾„ä½¿ç”¨ folder_paths.get_full_path("checkpoints", ckpt_name)ã€‚
åˆ—å‡ºæ¨¡å‹åˆ—è¡¨ä½¿ç”¨ folder_paths.get_filename_list("checkpoints")ã€‚
æ’ä»¶å†…éƒ¨èµ„æºå¼•ç”¨ï¼š
å¦‚æœéœ€è¦å¼•ç”¨å½“å‰æ’ä»¶æ–‡ä»¶å¤¹å†…çš„æ–‡ä»¶ï¼ˆå¦‚é»˜è®¤é…ç½®ã€å›¾æ ‡ï¼‰ï¼Œå¿…é¡»ä½¿ç”¨ç›¸å¯¹è·¯å¾„é”šå®šï¼š
<PYTHON>
import os
current_dir = os.path.dirname(os.path.abspath(__file__))
config_path = os.path.join(current_dir, "config.json")
æ¨¡å‹ä¸‹è½½é€»è¾‘ï¼š
ä¸‹è½½æ¨¡å‹æ—¶ï¼Œç›®æ ‡è·¯å¾„åº”åŠ¨æ€è·å– folder_paths.models_dirï¼Œä¸å¯ç¡¬ç¼–ç ã€‚
å¿…é¡»æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤ä¸‹è½½ã€‚  

### èŠ‚ç‚¹å¼€å‘æ¶æ„è§„èŒƒ
ç±»ç»“æ„å®Œæ•´æ€§ï¼š
å¿…é¡»åŒ…å« INPUT_TYPES (ç±»æ–¹æ³•), RETURN_TYPES, RETURN_NAMES, FUNCTION, CATEGORYã€‚
CATEGORY ç»Ÿä¸€å‘½åä¸º DapaoAPI æˆ–å…¶å­ç±»ã€‚
æ³¨å†Œè§„èŒƒï¼š
åœ¨ __init__.py ä¸­å¯¼å‡ºèŠ‚ç‚¹ç±»ã€‚
å¿…é¡»ç»´æŠ¤ NODE_CLASS_MAPPINGS å’Œ NODE_DISPLAY_NAME_MAPPINGSã€‚
èŠ‚ç‚¹æ˜¾ç¤ºåç§°ï¼ˆDisplay Nameï¼‰åº”åŠ å‰ç¼€ Dapao -  ä»¥ä¾¿æœç´¢ã€‚

### æ•°æ®ä¸å›¾åƒå¤„ç†è§„èŒƒ
- å¼ é‡å½¢çŠ¶æ ‡å‡†ï¼š
- å›¾åƒè¾“å…¥/è¾“å‡ºï¼š[B, H, W, C] (Batch, Height, Width, Channel)ã€‚
- é®ç½©è¾“å…¥/è¾“å‡ºï¼š[B, H, W]ã€‚
- æ•°æ®ç±»å‹ä¸èŒƒå›´ï¼š
å›¾åƒ Tensor å¿…é¡»æ˜¯ float32ï¼Œæ•°å€¼èŒƒå›´ 0.0 - 1.0ã€‚
API è¿”å›çš„ Base64 å›¾ç‰‡å¿…é¡»ç»è¿‡ pil2tensor è½¬æ¢åè¾“å‡ºã€‚
è½¬æ¢å·¥å…·ï¼š
ç†Ÿç»ƒä½¿ç”¨è¾…åŠ©å‡½æ•°ï¼špil2tensor() å’Œ tensor2pil()ã€‚
### é…ç½®æ–‡ä»¶é€»è¾‘ (API ä¸“ç”¨)
Config åŠ è½½å™¨ï¼š
ç¼–å†™ä¸€ä¸ªå•ä¾‹æˆ–å·¥å…·å‡½æ•°æ¥å®‰å…¨åŠ è½½é…ç½®ã€‚
å¦‚æœåœ¨ config.json ä¸­æ‰¾ä¸åˆ° Keyï¼Œä¸è¦è‡ªåŠ¨å†™å…¥ï¼Œè€Œæ˜¯æŠ›å‡ºå‹å¥½çš„é”™è¯¯æç¤ºç”¨æˆ·ï¼šâ€œè¯·åœ¨ config.json ä¸­é…ç½®æ‚¨çš„ API Key æˆ–åœ¨èŠ‚ç‚¹è¾“å…¥æ¡†ä¸­å¡«å†™â€ã€‚
å‚æ•°è¦†ç›–ï¼š
é€»è¾‘é¡ºåºï¼šèŠ‚ç‚¹Widgetè¾“å…¥ > config.json > ç¯å¢ƒå˜é‡ã€‚

### éšæœºç§å­å®ç°è§„èŒƒ (æ ¸å¿ƒåŠŸèƒ½)
æ‰€æœ‰æ¶‰åŠéšæœºæ€§çš„èŠ‚ç‚¹å¿…é¡»éµå¾ªä»¥ä¸‹æ ‡å‡†å®ç°ï¼Œä»¥ç¡®ä¿ ComfyUI çš„å¤ç°æ€§å’Œéšæœºæ€§æ§åˆ¶ï¼š

1.  **INPUT_TYPES å®šä¹‰**ï¼š
    å¿…é¡»åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªå‚æ•°ï¼š
    ```python
    "ğŸ² éšæœºç§å­": ("INT", {
        "default": -1,
        "min": -1,
        "max": 0xffffffffffffffff,
        "tooltip": "éšæœºç§å­ï¼Œ-1ä¸ºéšæœº"
    }),
    "ğŸ¯ ç§å­æ§åˆ¶": (["éšæœº", "å›ºå®š", "é€’å¢"], {"default": "éšæœº"}),
    ```

2.  **IS_CHANGED å¼ºåˆ¶æ›´æ–°é€»è¾‘**ï¼š
    å¿…é¡»å®ç° `IS_CHANGED` ç±»æ–¹æ³•ï¼Œä»¥å¤„ç† ComfyUI çš„ç¼“å­˜æœºåˆ¶ï¼š
    ```python
    @classmethod
    def IS_CHANGED(cls, **kwargs):
        seed_control = kwargs.get("ğŸ¯ ç§å­æ§åˆ¶", "éšæœº")
        seed = kwargs.get("ğŸ² éšæœºç§å­", -1)
        
        # éšæœºå’Œé€’å¢æ¨¡å¼ä¸‹ï¼Œå¼ºåˆ¶æ›´æ–° (è¿”å› NaN)
        if seed_control in ["éšæœº", "é€’å¢"]:
            return float("nan")
        
        # å›ºå®šæ¨¡å¼ä¸‹ï¼Œä»…å½“ç§å­å€¼å˜åŒ–æ—¶æ›´æ–°
        return seed
    ```

3.  **åˆå§‹åŒ–ä¸çŠ¶æ€è¿½è¸ª**ï¼š
    åœ¨ `__init__` ä¸­åˆå§‹åŒ– `last_seed`ï¼š
    ```python
    def __init__(self):
        self.last_seed = -1
    ```

4.  **æ‰§è¡Œé€»è¾‘ (FUNCTION)**ï¼š
    åœ¨ä¸»æ‰§è¡Œå‡½æ•°ä¸­å¤„ç†ç§å­é€»è¾‘ï¼š
    ```python
    seed = kwargs.get("ğŸ² éšæœºç§å­", -1)
    seed_control = kwargs.get("ğŸ¯ ç§å­æ§åˆ¶", "éšæœº")

    if seed_control == "å›ºå®š":
        effective_seed = seed if seed != -1 else random.randint(0, 2147483647)
    elif seed_control == "éšæœº":
        effective_seed = random.randint(0, 2147483647)
    elif seed_control == "é€’å¢":
        if self.last_seed == -1:
            effective_seed = seed if seed != -1 else random.randint(0, 2147483647)
        else:
            effective_seed = self.last_seed + 1
    else:
        effective_seed = random.randint(0, 2147483647)
    
    self.last_seed = effective_seed
    # åç»­ä½¿ç”¨ effective_seed è¿›è¡Œéšæœºæ“ä½œæˆ–ä¼ ç»™ API
    ```
